"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1613],{7758:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>a,metadata:()=>o,toc:()=>d});var n=s(4848),i=s(8453);const a={},r="Lido tokens integration guide",o={id:"guides/lido-tokens-integration-guide",title:"Lido tokens integration guide",description:"This document is intended for developers looking to integrate Lido's stETH or wstETH tokens into their dApps or services, with a focus on money markets, DEXes and blockchain bridges.",source:"@site/docs/guides/lido-tokens-integration-guide.md",sourceDirName:"guides",slug:"/guides/lido-tokens-integration-guide",permalink:"/lido-docs-spanish/guides/lido-tokens-integration-guide",draft:!1,unlisted:!1,editUrl:"https://github.com/adminseedlatam/lido-docs-spanish/edit/main/docs/guides/lido-tokens-integration-guide.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Lido DAO",permalink:"/lido-docs-spanish/lido-dao"},next:{title:"General Overview",permalink:"/lido-docs-spanish/guides/node-operators/general-overview"}},l={},d=[{value:"Lido",id:"lido",level:2},{value:"Lido tokens",id:"lido-tokens",level:2},{value:"stTokens: stETH and wstETH",id:"sttokens-steth-and-wsteth",level:3},{value:"Integration utilities: Rate and price feeds",id:"integration-utilities-rate-and-price-feeds",level:4},{value:"LDO",id:"ldo",level:3},{value:"unstETH",id:"unsteth",level:3},{value:"stETH vs. wstETH",id:"steth-vs-wsteth",level:2},{value:"stETH",id:"steth",level:2},{value:"What is stETH",id:"what-is-steth",level:3},{value:"Note on ERC-20 compliance",id:"note-on-erc-20-compliance",level:3},{value:"Accounting oracle",id:"accounting-oracle",level:3},{value:"Oracle corner cases",id:"oracle-corner-cases",level:4},{value:"stETH internals: share mechanics",id:"steth-internals-share-mechanics",level:3},{value:"1-2 wei corner case",id:"1-2-wei-corner-case",level:4},{value:"Bookkeeping shares",id:"bookkeeping-shares",level:3},{value:"Transfer shares function for stETH",id:"transfer-shares-function-for-steth",level:3},{value:"Fees",id:"fees",level:3},{value:"How to get APR?",id:"how-to-get-apr",level:3},{value:"Do stETH rewards compound?",id:"do-steth-rewards-compound",level:3},{value:"wstETH",id:"wsteth",level:2},{value:"What is wstETH",id:"what-is-wsteth",level:3},{value:"Wrap &amp; Unwrap",id:"wrap--unwrap",level:3},{value:"wstETH shortcut",id:"wsteth-shortcut",level:4},{value:"Rewards accounting",id:"rewards-accounting",level:3},{value:"Hole\u0161ky or Sepolia wstETH for testing",id:"hole\u0161ky-or-sepolia-wsteth-for-testing",level:3},{value:"wstETH on L2s",id:"wsteth-on-l2s",level:3},{value:"LDO",id:"ldo-1",level:2},{value:"What is LDO",id:"what-is-ldo",level:3},{value:"Note on ERC-20 compliance",id:"note-on-erc-20-compliance-1",level:3},{value:"ERC20Permit",id:"erc20permit",level:2},{value:"Staking rate limits",id:"staking-rate-limits",level:2},{value:"Alternative routes",id:"alternative-routes",level:3},{value:"Withdrawals (unstETH)",id:"withdrawals-unsteth",level:2},{value:"Request withdrawal and mint NFT",id:"request-withdrawal-and-mint-nft",level:3},{value:"stETH",id:"steth-1",level:4},{value:"wstETH",id:"wsteth-1",level:4},{value:"Checking the state of withdrawal",id:"checking-the-state-of-withdrawal",level:3},{value:"Claiming",id:"claiming",level:3},{value:"General integration examples",id:"general-integration-examples",level:2},{value:"stETH/wstETH as collateral",id:"stethwsteth-as-collateral",level:3},{value:"Wallet integrations",id:"wallet-integrations",level:3},{value:"Cross chain bridging",id:"cross-chain-bridging",level:3},{value:"Risks",id:"risks",level:2},{value:"Smart contract security",id:"smart-contract-security",level:3},{value:"Slashing risk",id:"slashing-risk",level:3},{value:"stToken price risk",id:"sttoken-price-risk",level:3}];function h(e){const t={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"lido-tokens-integration-guide",children:"Lido tokens integration guide"}),"\n",(0,n.jsx)(t.p,{children:"This document is intended for developers looking to integrate Lido's stETH or wstETH tokens into their dApps or services, with a focus on money markets, DEXes and blockchain bridges."}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["The integration might be implemented on the level of smart contracts (on-chain) or ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/integrations/sdk#lido-ethereum-sdk",children:"Lido on Ethereum SDK"})," (off-chain)."]})}),"\n",(0,n.jsx)(t.h2,{id:"lido",children:"Lido"}),"\n",(0,n.jsx)(t.p,{children:"Lido is a family of liquid staking protocols across multiple blockchains, with headquarters on Ethereum.\nLiquid refers to the ability of a user\u2019s stake to become liquid. Upon the user's deposit Lido issues stToken, which represents the deposited tokens along with all the rewards & penalties accrued through the deposit's staking. Unlike the staked funds, this stToken is liquid \u2014 it can be freely transferred between parties, making it usable across different DeFi applications while still receiving daily staked rewards. It is paramount to preserve this property when integrating stTokens into any DeFi protocol."}),"\n",(0,n.jsx)(t.p,{children:"This guide refers to Lido on Ethereum (hereinafter referred to as Lido)."}),"\n",(0,n.jsx)(t.h2,{id:"lido-tokens",children:"Lido tokens"}),"\n",(0,n.jsx)(t.h3,{id:"sttokens-steth-and-wsteth",children:"stTokens: stETH and wstETH"}),"\n",(0,n.jsxs)(t.p,{children:["Staking ether with Lido gives an equivalent amount of ",(0,n.jsx)(t.a,{href:"#steth",children:"stETH"}),".\nThe user's stETH balance represents the amount of ether withdrawable directly from the Lido protocol."]}),"\n",(0,n.jsxs)(t.p,{children:["For easier DeFi integrations, ",(0,n.jsx)(t.code,{children:"stETH"})," has a non-rebasable value-accruing (non-rebasable) counterpart called ",(0,n.jsx)(t.a,{href:"#wsteth",children:"'wrapped stETH'"}),"\n(or just ",(0,n.jsx)(t.code,{children:"wstETH"}),")."]}),"\n",(0,n.jsx)(t.p,{children:"Lido's ERC-20 compatible stTokens are widely adopted across the Ethereum ecosystem:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["The most important on-chain ",(0,n.jsx)(t.a,{href:"https://dune.com/lido/wsteth-liquidity",children:"liquidity venues"})," include:","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://curve.fi/#/ethereum/pools/steth",children:"stETH/ETH liquidity pool on Curve"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.uniswap.org/explore/pools/ethereum/0x109830a1AAaD605BbF02a9dFA7B0B92EC2FB7dAa",children:"wstETH/ETH pool on Uniswap V3"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.balancer.fi/#/ethereum/pool/0x93d199263632a4ef4bb438f1feb99e57b4b5f0bd0000000000000000000005c2",children:"wstETH/ETH Composable stable pool on Balancer v2"})}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["wstETH is listed as a collateral token on the following AAVE v3 markets:","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0x7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&marketName=proto_mainnet_v3",children:"Ethereum mainnet"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0x5979d7b546e38e414f7e9822514be443a4800529&marketName=proto_arbitrum_v3",children:"Arbitrum"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0xf610a9dfb7c89644979b4a0f27063e9e7d7cda32&marketName=proto_scroll_v3",children:"Scroll"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0xc1cba3fcea344f92d9239c08c0568f6f2f0ee452&marketName=proto_base_v3",children:"Base"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0x1f32b1c2345538c0c6f582fcb022739c4a194ebb&marketName=proto_optimism_v3",children:"Optimism"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0x03b54a6e9a984069379fae1a4fc4dbae93b3bccd&marketName=proto_polygon_v3",children:"Polygon PoS"})}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["wstETH is ",(0,n.jsx)(t.a,{href:"https://daistats.com/#/collateral",children:"listed as a collateral token on Maker"})]}),"\n",(0,n.jsxs)(t.li,{children:["there are various ",(0,n.jsx)(t.a,{href:"https://app.mellow.finance/restake",children:"Mellow LRT"})," projects built on top of the (w)stETH"]}),"\n",(0,n.jsxs)(t.li,{children:["stETH is listed as a collateral token on the AAVE v2 ",(0,n.jsx)(t.a,{href:"https://app.aave.com/reserve-overview/?underlyingAsset=0xae7ab96520de3a18e5e111b5eaab095312d7fe84&marketName=proto_mainnet",children:"Ethereum mainnet"})," market"]}),"\n",(0,n.jsxs)(t.li,{children:["steCRV (the Curve stETH/ETH LP token) is ",(0,n.jsx)(t.a,{href:"https://daistats.com/#/collateral",children:"listed as a collateral token on Maker"})]}),"\n",(0,n.jsxs)(t.li,{children:["Blast L2 integrated ",(0,n.jsx)(t.a,{href:"https://docs.blastfutures.com/get-started/introduction/what-is-blast#how-blast-works",children:"stETH"})," as a rebasable ether (being staked implicitly as a part of the L1->L2 ether bridging flow)"]}),"\n",(0,n.jsxs)(t.li,{children:["there are multiple liquidity strategies built on top of Lido's stTokens, including ",(0,n.jsx)(t.a,{href:"https://yearn.fi/vaults/1/0xdCD90C7f6324cfa40d7169ef80b12031770B4325",children:"Yearn"})," and ",(0,n.jsx)(t.a,{href:"https://harvest.finance/",children:"Harvest Finance"})]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"integration-utilities-rate-and-price-feeds",children:"Integration utilities: Rate and price feeds"}),"\n",(0,n.jsx)(t.p,{children:"The current sentiment for the money markets and DeFi integrations in general is to consider Liquid Staked Tokens being backed by their native exchange rates against ETH.\nThis approach implies 1 stETH = 1 ETH pricing invariant to be used."}),"\n",(0,n.jsxs)(t.p,{children:["Real world applications include ",(0,n.jsx)(t.a,{href:"https://github.com/bgd-labs/aave-proposals/blob/main/src/AaveV2-V3PriceFeedsUpdate_20230613/PRICE-FEEDS-UPDATE-20230613.md#motivation",children:"AAVE v3"}),"\nmarkets and ",(0,n.jsx)(t.a,{href:"https://etherscan.io/address/0x1Dc89c28e59d142688D65Bd7b22C4Fd40C2cC06d",children:"Mellow LRT"})," pricing approaches."]}),"\n",(0,n.jsxs)(t.p,{children:["More in depth analysis is available ",(0,n.jsx)(t.a,{href:"https://www.comp.xyz/t/franklin-dao-request-for-comment-on-market-pricing-vs-exchange-rate-pricing-for-lsts-and-potential-oracle-implementations/5130",children:"here"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["There are following ",(0,n.jsx)(t.code,{children:"wstETH/stETH"})," rate feeds available to use in conjunction with (w)stETH:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://etherscan.io/address/0x94336dF517036f2Bf5c620a1BC75a73A37b7bb16#readContract",children:"Ethereum Mainnet"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/arbitrum/mainnet/wsteth-steth%20exchangerate",children:"Arbitrum"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/optimism/mainnet/wsteth-steth%20exchangerate",children:"Optimism"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/scroll/mainnet/wsteth-steth%20exchangerate",children:"Scroll"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/base/base/wsteth-steth%20exchangerate",children:"Base"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/polygon/mainnet/wsteth-steth",children:"Polygon PoS"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://data.chain.link/feeds/zksync/zksync/wsteth-steth%20exchangerate",children:"ZKSync Era"})}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["The Ethereum Mainnet Chainlink-compatible feed is deployed and used by the Mellow LRT vaults, being a wrapper for ",(0,n.jsx)(t.code,{children:"wstETH.getStETHByWstETH(10 ** decimals)"})]})}),"\n",(0,n.jsxs)(t.p,{children:["These feeds might be used to compose a target feed, e.g., for the ",(0,n.jsx)(t.code,{children:"wstETH/USD"})," pair, see the following examples of AAVE v3 markets:"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsxs)(t.a,{href:"https://etherscan.io/address/0x8b6851156023f4f5a66f68bea80851c3d905ac93#code",children:["Ethereum Mainnet ",(0,n.jsx)(t.code,{children:"WstETHSynchronicityPriceAdapter"})]})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsxs)(t.a,{href:"https://optimistic.etherscan.io/address/0x80f2c02224a2e548fc67c0bf705ebfa825dd5439",children:["Optimism ",(0,n.jsx)(t.code,{children:"CLSynchronicityPriceAdapterPegToBase"})]})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsxs)(t.a,{href:"https://arbiscan.io/address/0x945fd405773973d286de54e44649cc0d9e264f78",children:["Arbitrum ",(0,n.jsx)(t.code,{children:"CLSynchronicityPriceAdapterPegToBase"})]})}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"ldo",children:"LDO"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.a,{href:"#ldo-1",children:"LDO"})," is a Lido governance ERC-20 compliant token derived from the ",(0,n.jsx)(t.a,{href:"https://github.com/Giveth/minime",children:"MiniMe Token"}),".\nThus, LDO holder balances are queryable for an arbitrary block number, an essential security feature for the Lido voting mechanics."]}),"\n",(0,n.jsx)(t.h3,{id:"unsteth",children:"unstETH"}),"\n",(0,n.jsxs)(t.p,{children:["A non-fungible token (NFT) is used to represent a withdrawal request position ",(0,n.jsx)(t.a,{href:"/contracts/withdrawal-queue-erc721",children:"in the protocol-level withdrawals queue"})," when a stToken holder decides to redeem it for ether via the protocol."]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["Unlike the other Lido's tokens (",(0,n.jsx)(t.code,{children:"stETH"}),", ",(0,n.jsx)(t.code,{children:"wstETH"}),", and ",(0,n.jsx)(t.code,{children:"LDO"}),"), ",(0,n.jsx)(t.a,{href:"#withdrawals-unsteth",children:"unstETH"})," is non-fungible,\nand implements the ERC-721 token standard instead of ERC-20."]})}),"\n",(0,n.jsx)(t.h2,{id:"steth-vs-wsteth",children:"stETH vs. wstETH"}),"\n",(0,n.jsx)(t.p,{children:"There are two versions of Lido's stTokens, namely stETH and wstETH.\nBoth are fungible tokens but they reflect the accrued staking rewards differently. stETH implements rebasing mechanics which means the stETH balance updates regularly. On the contrary, the wstETH balance does not change on its own but rather increases in value against stETH."}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsx)(t.p,{children:"At any moment, any amount of stETH can be converted to wstETH via a trustless wrapper and vice versa, thus tokens effectively share liquidity."})}),"\n",(0,n.jsx)(t.p,{children:"For instance, undercollateralized wstETH positions on Maker can be liquidated by unwrapping wstETH and swapping it for ether on Curve."}),"\n",(0,n.jsx)(t.h2,{id:"steth",children:"stETH"}),"\n",(0,n.jsx)(t.h3,{id:"what-is-steth",children:"What is stETH"}),"\n",(0,n.jsx)(t.p,{children:"stETH is a rebasable ERC-20 token that represents ether staked with Lido. Unlike staked ether, it is liquid and can be transferred, traded, or used in DeFi applications. The total supply of stETH reflects the amount of ether deposited into protocol combined with staking rewards, minus potential validator penalties. stETH tokens are minted upon ether deposit at 1:1 ratio. Since withdrawals from the Consensus Layer have been introduced, it is also possible to redeem ether by burning stETH at the same 1:1 ratio (in rare cases it won't preserve 1:1 ratio though)."}),"\n",(0,n.jsxs)(t.p,{children:["Please note, Lido has implemented staking rate limits aimed at reducing the post-Merge staking surge's impact on the staking queue & Lido\u2019s socialized rewards distribution model. Read more about it ",(0,n.jsx)(t.a,{href:"#staking-rate-limits",children:"here"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["stETH is a rebasable ERC-20 token. Normally, the stETH token balances get recalculated daily when the Lido oracle reports the Consensus Layer ether balance update. The stETH balance update happens automatically on all the addresses holding stETH at the moment of rebase. The rebase mechanics have been implemented via shares (see ",(0,n.jsx)(t.a,{href:"#steth-internals-share-mechanics",children:"shares"}),")."]}),"\n",(0,n.jsx)(t.h3,{id:"note-on-erc-20-compliance",children:"Note on ERC-20 compliance"}),"\n",(0,n.jsxs)(t.p,{children:["stETH does not strictly comply with ERC-20. The only exception is that it does not emit ",(0,n.jsx)(t.code,{children:"Transfer()"})," on rebase as ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-20#events",children:"ERC-20"})," standard requires."]}),"\n",(0,n.jsx)(t.h3,{id:"accounting-oracle",children:"Accounting oracle"}),"\n",(0,n.jsx)(t.p,{children:"Normally, stETH rebases happen daily when the Lido oracle reports the Consensus Layer ether balance update. The rebase can be positive or negative, depending on the validators' performance. In case Lido's validators get slashed or penalized, the stETH balances can decrease according to penalty sizes. However, daily rebases have never been negative by the time of writing."}),"\n",(0,n.jsxs)(t.p,{children:["The accounting oracle has sanity checks on both max APR reported (the APR cannot exceed 27%, which means a daily rebase is limited to ",(0,n.jsx)(t.code,{children:"(27/365)%"}),") and total staked amount drop (staked ether decrease reported cannot exceed 5%)."]}),"\n",(0,n.jsx)(t.p,{children:"Currently, Oracle network includes 9 independent oracles, oracle daemons hosted by established node operators selected by the DAO.\nAs soon as five out of nine oracle daemons report the same data, reaching the consensus, the report goes to the Lido smart contract, and the rebase occurs."}),"\n",(0,n.jsx)(t.h4,{id:"oracle-corner-cases",children:"Oracle corner cases"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"In case oracle daemons do not report Consensus Layer balance update or do not reach quorum, the oracle does not submit the daily report, and the daily rebase doesn't occur until the quorum is reached."}),"\n",(0,n.jsx)(t.li,{children:"Oracle report might be delayed, but it will include values actual for the reporting refSlot. So, even if reported 2 hours late, it will include only rebase values for the original period."}),"\n",(0,n.jsx)(t.li,{children:"In case the quorum hasn't been reached, the oracle can skip the daily report. The report will happen as soon as the quorum for one of the next periods will be reached, and it will include the incremental balance update for all periods since the last successful oracle report."}),"\n",(0,n.jsx)(t.li,{children:"Oracle daemons only report the finalized epochs. In case of no finality on the Consensus Layer, the daemons won't submit their reports, and the daily rebase won't occur."}),"\n",(0,n.jsx)(t.li,{children:"In case sanity checks on max APR or total staked amount drop fail, the oracle report cannot be finalized, and the rebase cannot happen."}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"steth-internals-share-mechanics",children:"stETH internals: share mechanics"}),"\n",(0,n.jsxs)(t.p,{children:["Daily rebases result in stETH token balances changing. This mechanism is implemented via shares.\nThe ",(0,n.jsx)(t.code,{children:"share"})," is a basic unit representing the stETH holder's share in the total amount of ether controlled by the protocol. When a new deposit happens, the new shares get minted to reflect what share of the protocol-controlled ether has been added to the pool. When the Consensus Layer oracle report comes in, the price of 1 share in stETH is being recalculated. Shares aren't normalized, so the contract also stores the sum of all shares to calculate each account's token balance.\nShares balance by stETH balance can be calculated by this formula:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"shares[account] = balanceOf(account) * totalShares / totalPooledEther\n"})}),"\n",(0,n.jsx)(t.h4,{id:"1-2-wei-corner-case",children:"1-2 wei corner case"}),"\n",(0,n.jsxs)(t.p,{children:["stETH balance calculation includes integer division, and there is a common case when the whole stETH balance can't be transferred from the account while leaving the last 1-2 wei on the sender's account. The same thing can actually happen at any transfer or deposit transaction. In the future, when the stETH/share rate will be greater, the error can become a bit bigger. To avoid it, one can use ",(0,n.jsx)(t.code,{children:"transferShares"})," to be precise."]}),"\n",(0,n.jsx)(t.p,{children:"Example:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"User A transfers 1 stETH to User B."}),"\n",(0,n.jsx)(t.li,{children:"Under the hood, stETH balance gets converted to shares, integer division happens and rounding down applies."}),"\n",(0,n.jsx)(t.li,{children:"The corresponding amount of shares gets transferred from User A to User B."}),"\n",(0,n.jsx)(t.li,{children:"Shares balance gets converted to stETH balance for User B."}),"\n",(0,n.jsx)(t.li,{children:"In many cases, the actually transferred amount is 1-2 wei less than expected."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["The issue is documented here: ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/issues/442",children:"lido-dao/issues/442"})]}),"\n",(0,n.jsx)(t.h3,{id:"bookkeeping-shares",children:"Bookkeeping shares"}),"\n",(0,n.jsx)(t.p,{children:"Although user-friendly, stETH rebases add a whole level of complexity to integrating stETH into other dApps and protocols. When integrating stETH as a token into any dApp, it's highly recommended to store and operate shares rather than stETH public balances directly, because stETH balances change both upon transfers, mints/burns, and rebases, while shares balances can only change upon transfers and mints/burns."}),"\n",(0,n.jsxs)(t.p,{children:["To figure out the shares balance, ",(0,n.jsx)(t.code,{children:"getSharesByPooledEth(uint256)"})," function can be used. It returns the value not affected by future rebases and it can be converted back into stETH by calling ",(0,n.jsx)(t.code,{children:"getPooledEthByShares"})," function."]}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsxs)(t.p,{children:["See all available stETH methods ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/docs/blob/main/docs/contracts/lido.md#view-methods",children:"here"}),"."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Any operation on stETH can be performed on shares directly, with no difference between share and stETH."}),"\n",(0,n.jsx)(t.p,{children:"The preferred way of operating stETH should be:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"get stETH token balance;"}),"\n",(0,n.jsx)(t.li,{children:"convert stETH balance into shares balance and use it as a primary balance unit in your dApp;"}),"\n",(0,n.jsx)(t.li,{children:"when any operation on the balance should be done, do it on the shares balance;"}),"\n",(0,n.jsx)(t.li,{children:"when users interact with stETH, convert the shares balance back to stETH token balance."}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Please note that 10% APR on shares balance and 10% APR on stETH token balance will ultimately result in different output values over time, because shares balance is stable, while stETH token balance changes eventually."}),"\n",(0,n.jsx)(t.p,{children:"There are two convenience methods to work with shares available for the stETH token:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"transferShares"})," (when ",(0,n.jsx)(t.code,{children:"msg.sender"})," spends their own balance)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"transferSharesFrom"})," (when ",(0,n.jsx)(t.code,{children:"msg.sender"})," spends the approved allowance)"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["If using the rebasable stETH token is not an option for your integration, it is recommended to use wstETH instead of stETH. See how it works ",(0,n.jsx)(t.a,{href:"#wsteth",children:"here"}),"."]}),"\n",(0,n.jsx)(t.h3,{id:"transfer-shares-function-for-steth",children:"Transfer shares function for stETH"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-improvement-proposals/blob/develop/LIPS/lip-11.md",children:"LIP-11"})," introduced the ",(0,n.jsx)(t.code,{children:"transferShares"}),' function which allows to transfer stETH in a "rebase-agnostic" manner: transfer in terms of ',(0,n.jsx)(t.a,{href:"#steth-internals-share-mechanics",children:"shares"})," amount."]}),"\n",(0,n.jsxs)(t.p,{children:["Normally, one transfers stETH using ERC-20 ",(0,n.jsx)(t.code,{children:"transfer"})," and ",(0,n.jsx)(t.code,{children:"transferFrom"})," functions which accept as an input the amount of stETH, not the amount of the underlying shares.\nSometimes it's better operate with shares directly to avoid possible rounding issues. Rounding issues usually could appear after a token rebase.\nThis feature is aimed to provide an additional level of precision when operating with stETH.\nRead more about the function in the ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-improvement-proposals/blob/develop/LIPS/lip-11.md",children:"LIP-11"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["Also, V2 upgrade introduced a ",(0,n.jsx)(t.code,{children:"transferSharesFrom"})," to completely match ERC-20 set of transfer methods."]}),"\n",(0,n.jsx)(t.h3,{id:"fees",children:"Fees"}),"\n",(0,n.jsx)(t.p,{children:"Lido collects a percentage of the staking rewards as a protocol fee. The exact fee size is defined by the DAO and can be changed in the future via DAO voting. To collect the fee, the protocol mints new stETH token shares and assigns them to the fee recipients. Currently, the fee collected by Lido protocol is 10% of staking rewards with half of it going to the node operators and the other half going to the protocol treasury."}),"\n",(0,n.jsx)(t.p,{children:"Since the total amount of Lido pooled ether tends to increase, the combined value of all holders' shares denominated in stETH increases respectively. Thus, the rewards effectively spread between each token holder proportionally to their share in the protocol TVL. So Lido mints new shares to the fee recipient so that the total cost of the newly-minted shares exactly corresponds to the fee taken (calculated in basis points):"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"shares2mint * newShareCost = (_totalRewards * feeBasis) / 10000\nnewShareCost = newTotalPooledEther / (prevTotalShares + shares2mint)\n"})}),"\n",(0,n.jsx)(t.p,{children:"which follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"                        _totalRewards * feeBasis * prevTotalShares\nshares2mint = --------------------------------------------------------------\n                (newTotalPooledEther * 10000) - (feeBasis * _totalRewards)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"how-to-get-apr",children:"How to get APR?"}),"\n",(0,n.jsxs)(t.p,{children:["Please refer to ",(0,n.jsx)(t.a,{href:"https://docs.lido.fi/integrations/api/#last-lido-apr-for-steth",children:"this page"})," for the correct Lido V2 APR calculation."]}),"\n",(0,n.jsx)(t.p,{children:"It is worth noting that with withdrawals enabled, the APR calculation method for Lido has changed significantly.\nWhen Lido V2 protocol finalizes withdrawal requests, the Lido contract excludes funds from TVL and assigns to burn underlying locked requests\u2019 stETH shares in return. In other words, withdrawal finalization decreases both TVL and total shares.\nThe old V1 formula isn\u2019t suitable anymore because it catches TVL changes, but skips total shares changes."}),"\n",(0,n.jsx)(t.h3,{id:"do-steth-rewards-compound",children:"Do stETH rewards compound?"}),"\n",(0,n.jsx)(t.p,{children:"Yes, stETH rewards do compound."}),"\n",(0,n.jsx)(t.p,{children:"All rewards that are withdrawn from the Consensus Layer or received as MEV or EL priority fees (that aren't used to fulfill withdrawal requests) are finally restaked to set up new validators and receive more rewards at the end. So, we can say that stETH becomes fully auto-compounding after V2 release."}),"\n",(0,n.jsx)(t.h2,{id:"wsteth",children:"wstETH"}),"\n",(0,n.jsx)(t.p,{children:"Due to the rebasing nature of stETH, the stETH balance on the holder's address is not constant, it changes daily as oracle report comes in.\nAlthough rebasable tokens are becoming a common thing in DeFi recently, many dApps do not support rebasing. For example, Maker, UniSwap, and SushiSwap are not designed for rebasable tokens. Listing stETH on these apps can result in holders not receiving their daily staking rewards which effectively defeats the benefits of liquid staking. To integrate with such dApps, there's another form of Lido stTokens called wstETH (wrapped staked ether)."}),"\n",(0,n.jsx)(t.h3,{id:"what-is-wsteth",children:"What is wstETH"}),"\n",(0,n.jsxs)(t.p,{children:["wstETH is an ERC20 token that represents the account's share of the stETH total supply (stETH token wrapper with static balances). For wstETH, 1 wei in ",(0,n.jsx)(t.a,{href:"#steth-internals-share-mechanics",children:"shares"})," equals to 1 wei in balance. The wstETH balance can only be changed upon transfers, minting, and burning. wstETH balance does not rebase, wstETH's price denominated in stETH changes instead.\nAt any given time, anyone holding wstETH can convert any amount of it to stETH at a fixed rate, and vice versa. The rate is the same for everyone at any given moment. Normally, the rate gets updated once a day, when stETH undergoes a rebase. The current rate can be obtained by calling ",(0,n.jsx)(t.code,{children:"wstETH.stEthPerToken()"})," or ",(0,n.jsx)(t.code,{children:"wstETH.getStETHByWstETH(10 ** decimals)"}),"."]}),"\n",(0,n.jsx)(t.h3,{id:"wrap--unwrap",children:"Wrap & Unwrap"}),"\n",(0,n.jsxs)(t.p,{children:["When wrapping stETH to wstETH, the desired amount of stETH is locked on the WstETH contract balance, and the wstETH is minted according to the ",(0,n.jsx)(t.a,{href:"#bookkeeping-shares",children:"share bookkeeping"})," formula."]}),"\n",(0,n.jsx)(t.p,{children:"When unwrapping, wstETH gets burnt and the corresponding amount of stETH gets unlocked."}),"\n",(0,n.jsx)(t.p,{children:"Thus, the amount of stETH unlocked when unwrapping is different from what has been initially wrapped (given a rebase happened between wrapping and unwrapping stETH)."}),"\n",(0,n.jsx)(t.h4,{id:"wsteth-shortcut",children:"wstETH shortcut"}),"\n",(0,n.jsxs)(t.p,{children:["Note, that the WstETH contract includes a shortcut to convert ether to wstETH under the hood, which allows you to effectively skip the wrapping step and stake ether for wstETH directly. Keep in mind that when using the shortcut, ",(0,n.jsx)(t.a,{href:"#staking-rate-limits",children:"the staking rate limits"})," still apply."]}),"\n",(0,n.jsx)(t.h3,{id:"rewards-accounting",children:"Rewards accounting"}),"\n",(0,n.jsx)(t.p,{children:"Since wstETH represents the holder's share in the total amount of Lido-controlled ether, rebases don't affect wstETH balances but change the wstETH price denominated in stETH."}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:"Basic example"}),":"]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"User wraps 1 stETH and gets 0.9803 wstETH (1 stETH = 0.9803 wstETH)"}),"\n",(0,n.jsx)(t.li,{children:"A rebase happens, the wstETH price goes up by 5%"}),"\n",(0,n.jsx)(t.li,{children:"User unwraps 0.9803 wstETH and gets 1.0499 stETH (1 stETH = 0.9337 wstETH)"}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"hole\u0161ky-or-sepolia-wsteth-for-testing",children:"Hole\u0161ky or Sepolia wstETH for testing"}),"\n",(0,n.jsxs)(t.p,{children:["The most recent testnet version of the Lido protocol lives on the Hole\u0161ky testnet (",(0,n.jsx)(t.a,{href:"https://docs.lido.fi/deployed-contracts/holesky",children:"see the full list of contracts deployed here"}),"). Just like on mainnet, Hole\u0161ky wstETH for testing purposes can be obtained by approving the desired amount of stETH to the WstETH contract on Hole\u0161ky, and then calling ",(0,n.jsx)(t.code,{children:"wrap"})," method on it. The corresponding amount of Hole\u0161ky stETH will be locked on the WstETH contract, and the wstETH tokens will be minted to your account. Hole\u0161ky ether can also be converted to wstETH directly using the ",(0,n.jsx)(t.a,{href:"#wsteth-shortcut",children:"wstETH shortcut"})," \u2013 just send your Hole\u0161ky ether to WstETH contract on Hole\u0161ky, and the corresponding amount of wstETH will be minted to your account."]}),"\n",(0,n.jsxs)(t.p,{children:["The minimal version of the protocol is also deployed on the Sepolia testnet (",(0,n.jsx)(t.a,{href:"https://docs.lido.fi/deployed-contracts/sepolia",children:"see the full list of contracts deployed here"}),"). The process of getting wstETH is the same as described above for Hole\u0161ky. Note that the protocol setup on Sepolia has no UIs and various services available on Hole\u0161ky and Mainnet. For instance, the in-protocol ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/contracts/withdrawal-queue-erc721",children:"withdrawals"})," aren't available (paused indefinitely), please use the Hole\u0161ky testnet deployment if possible."]}),"\n",(0,n.jsx)(t.h3,{id:"wsteth-on-l2s",children:"wstETH on L2s"}),"\n",(0,n.jsxs)(t.p,{children:["Currently, wstETH token is ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/deployed-contracts/#lido-on-l2",children:"present on"}),":"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://arbiscan.io/address/0x5979D7b546E38E414F7E9822514be443A4800529",children:"Arbitrum"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://optimistic.etherscan.io/address/0x1F32b1c2345538c0c6f582fCB022739c4A194Ebb",children:"Optimism"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://scrollscan.com/address/0xf610A9dfB7C89644979b4A0f27063E9e7d7Cda32",children:"Scroll"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://basescan.org/address/0xc1CBa3fCea344f92D9239c08C0568f6F2F0ee452",children:"Base"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://lineascan.build/address/0xB5beDd42000b71FddE22D3eE8a79Bd49A568fC8F",children:"Linea"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://docs.lido.fi/deployed-contracts/#zksync-era",children:"ZKSync Era"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://explorer.mantle.xyz/address/0x458ed78EB972a369799fb278c0243b25e5242A83",children:"Mantle"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://polygonscan.com/token/0x03b54a6e9a984069379fae1a4fc4dbae93b3bccd",children:"Polygon PoS"})}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["with bridging implemented via ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/token-guides/wsteth-bridging-guide",children:"the canonical bridges recommended approach"}),"."]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"Unlike on the Ethereum mainnet, wstETH on L2s is a plain ERC-20 token and cannot be unwrapped to unlock stETH on the corresponding L2 network as of now."})}),"\n",(0,n.jsxs)(t.p,{children:["Without the shares bookkeeping, the token cannot provide the ",(0,n.jsx)(t.code,{children:"wstETH/stETH"})," rate and the rewards accrued on-chain.\nUse the ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/guides/lido-tokens-integration-guide#integration-utilities-rate-and-price-feeds",children:"wstETH/stETH rate feeds"})," listed above."]}),"\n",(0,n.jsx)(t.h2,{id:"ldo-1",children:"LDO"}),"\n",(0,n.jsx)(t.h3,{id:"what-is-ldo",children:"What is LDO"}),"\n",(0,n.jsxs)(t.p,{children:["LDO is a governance token used for the Lido DAO's voting process (",(0,n.jsx)(t.a,{href:"https://lido.fi/governance#regular-process",children:"both off-chain and on-chain"}),").\nThe token is widely available in DeFi and CeFi ecosystems."]}),"\n",(0,n.jsxs)(t.p,{children:["LDO has internal mechanics of the balance snapshots (",(0,n.jsx)(t.a,{href:"https://etherscan.io/address/0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32#readContract#F5",children:(0,n.jsx)(t.code,{children:"balanceOfAt"})})," and ",(0,n.jsx)(t.a,{href:"https://etherscan.io/address/0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32#readContract#F10",children:(0,n.jsx)(t.code,{children:"totalSupplyAt"})}),") to allow voting power not being manipulated within the time of the ongoing vote."]}),"\n",(0,n.jsx)(t.h3,{id:"note-on-erc-20-compliance-1",children:"Note on ERC-20 compliance"}),"\n",(0,n.jsxs)(t.p,{children:["Although the LDO is fully compliant with ERC-20, it is worth noting that the token doesn't revert a transaction on all of the\nfailure paths inside both ",(0,n.jsx)(t.code,{children:"transfer"})," and ",(0,n.jsx)(t.code,{children:"transferFrom"})," methods returning the ",(0,n.jsx)(t.code,{children:"false"})," status instead."]}),"\n",(0,n.jsxs)(t.admonition,{type:"note",children:[(0,n.jsxs)(t.p,{children:["It's critical to check the return status for external integrations as the ERC-20 token standard ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-20#methods",children:"requires"})," to prevent various attack vectors (e.g. token deposits in vaults):"]}),(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsxs)(t.p,{children:["Callers MUST handle ",(0,n.jsx)(t.code,{children:"false"})," from ",(0,n.jsx)(t.code,{children:"returns (bool success)"}),". Callers MUST NOT assume that ",(0,n.jsx)(t.code,{children:"false"})," is never returned!"]}),"\n"]})]}),"\n",(0,n.jsx)(t.h2,{id:"erc20permit",children:"ERC20Permit"}),"\n",(0,n.jsxs)(t.p,{children:["wstETH and stETH Ethereum Mainnet tokens implement the ERC20 Permit extension allowing approvals to be made via signatures, as defined in ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-2612",children:"EIP-2612"}),".\nstETH is also compatible with smart contract signatures, implementing ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-1271",children:"EIP-1271"})," that is used as a part of the Account Abstraction."]}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"permit"})," method allows users to modify the allowance using a signed message, instead of through ",(0,n.jsx)(t.code,{children:"msg.sender"}),".\nBy not relying on ",(0,n.jsx)(t.code,{children:"approve"})," method, you can build interfaces that will approve and use wstETH in one tx."]}),"\n",(0,n.jsx)(t.h2,{id:"staking-rate-limits",children:"Staking rate limits"}),"\n",(0,n.jsxs)(t.p,{children:["In order to handle the staking surge in case of some unforeseen market conditions, the Lido protocol implemented staking rate limits aimed at reducing the surge's impact on the staking queue & Lido\u2019s socialized rewards distribution model.\nThere is a sliding window limit that is parametrized with ",(0,n.jsx)(t.code,{children:"_maxStakingLimit"})," and ",(0,n.jsx)(t.code,{children:"_stakeLimitIncreasePerBlock"}),". This means it is only possible to submit this much ether to the Lido staking contracts within a 24-hours timeframe. Currently, the daily staking limit is set at 150,000 ether."]}),"\n",(0,n.jsxs)(t.p,{children:["You can picture this as a health globe from Diablo 2 with a maximum of ",(0,n.jsx)(t.code,{children:"_maxStakingLimit"})," and regenerating with a constant speed per block.\nWhen you deposit ether to the protocol, the level of health is reduced by its amount and the current limit becomes smaller and smaller.\nWhen it hits the ground, the transaction gets reverted."]}),"\n",(0,n.jsxs)(t.p,{children:["To avoid that, you should check if ",(0,n.jsx)(t.code,{children:"getCurrentStakeLimit() >= amountToStake"}),", and if it's not you can go with an alternative route.\nThe staking rate limits are denominated in ether, thus, it makes no difference if the stake is being deposited for stETH or using ",(0,n.jsx)(t.a,{href:"#wsteth-shortcut",children:"the wstETH shortcut"}),", the limits apply in both cases."]}),"\n",(0,n.jsx)(t.h3,{id:"alternative-routes",children:"Alternative routes"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Wait for staking limits to regenerate to higher values and retry depositing ether to Lido later."}),"\n",(0,n.jsx)(t.li,{children:"Consider swapping ETH for stETH on DEXes like Curve or Balancer. At specific market conditions, stETH may effectively be purchased from there with a discount due to stETH price fluctuations."}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"withdrawals-unsteth",children:"Withdrawals (unstETH)"}),"\n",(0,n.jsx)(t.p,{children:"Lido V2 introduced the possibility to withdraw ETH from the Lido on Ethereum protocol (i.e., primary market)."}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"As in-protocol withdrawals have asynchronous nature and sophisticated execution flow, in general,\nusing secondary markets (exchanges and swap aggregators) might be more UX-friendly and convenient option to consider\nfor integrations."})}),"\n",(0,n.jsxs)(t.p,{children:["A high-level upgrade overview can be found in ",(0,n.jsx)(t.a,{href:"https://blog.lido.fi/introducing-lido-v2/",children:"the blog post"}),".\nWithdrawals flow is organized as a FIFO queue that accepts the requests with stETH attached and these requests are finalized with oracle reports as soon as ether to fulfill the request is available."]}),"\n",(0,n.jsx)(t.p,{children:"So to obtain ether from the protocol, you'll need to proceed with the following steps:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"request the withdrawal, locking your steth in the queue and receiving an NFT, that represents your position in the queue"}),"\n",(0,n.jsx)(t.li,{children:"wait, until the request is finalized by the oracle report and becomes claimable"}),"\n",(0,n.jsx)(t.li,{children:"claim your ether, burning the NFT"}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Request size should be at least ",(0,n.jsx)(t.strong,{children:"100 wei"})," (in stETH) and at most ",(0,n.jsx)(t.strong,{children:"1000 stETH"}),". Larger amounts should be withdrawn in multiple requests, which can be batched via in-protocol API. Once requested, withdrawal cannot be canceled. The withdrawal NFT can be transferred to a different address, and the new owner will be able to claim the requested withdrawal once finalized."]}),"\n",(0,n.jsx)(t.p,{children:"The amount of claimable ETH is determined once the withdrawal request is finalized. The rate stETH/ETH of the request finalization can't get higher than it's been at the moment of request creation. The user will be able to claim:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"normally \u2013 the ETH amount corresponding to the stETH amount at the moment of the request's placement"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"OR"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"discounted - lowered ETH amount corresponding to the oracle-reported share rate in case the protocol had undergone significant losses (slashings and penalties)"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The second option is unlikely, and we haven't ever seen the conditions for it on mainnet so far."}),"\n",(0,n.jsxs)(t.p,{children:["The end-user contract to deal with the withdrawals is ",(0,n.jsx)(t.code,{children:"WithdrawalQueueERC721.sol"}),", which implements the ERC721 standard. NFT represents the position in the withdrawal queue and may be claimed after the finalization of the request."]}),"\n",(0,n.jsx)(t.p,{children:"Let's follow these steps in detail:"}),"\n",(0,n.jsx)(t.h3,{id:"request-withdrawal-and-mint-nft",children:"Request withdrawal and mint NFT"}),"\n",(0,n.jsx)(t.p,{children:"You have several options for requesting withdrawals, they require you to have stETH or wstETH on your address:"}),"\n",(0,n.jsx)(t.h4,{id:"steth-1",children:"stETH"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Call ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWithPermit(uint256[] _amounts, address _owner, PermitInput _permit)"})," and get the ids of created positions, where ",(0,n.jsx)(t.code,{children:"msg.sender"})," will be used to transfer tokens from and the ",(0,n.jsx)(t.code,{children:"_owner"})," will be the address that can claim or transfer NFT (defaults to ",(0,n.jsx)(t.code,{children:"msg.sender"})," if it\u2019s not provided)"]}),"\n",(0,n.jsxs)(t.li,{children:["Alternatively, sending stETH on behalf of ",(0,n.jsx)(t.code,{children:"WithdrawalQueueERC721.sol"})," contract can be approved in a separate upfront transaction (",(0,n.jsx)(t.code,{children:"stETH.approve(withdrawalQueueERC721.address, allowance)"}),"), and the ",(0,n.jsx)(t.code,{children:"requestWithdrawals(uint256[] _amounts, address _owner)"})," method called afterwards"]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"wsteth-1",children:"wstETH"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Call ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWstETHWithPermit(uint256[] _amounts, address _owner, PermitInput _permit)"})," and get the ids of created positions, where ",(0,n.jsx)(t.code,{children:"msg.sender"})," will be used to transfer tokens from, and the ",(0,n.jsx)(t.code,{children:"_owner"})," will be the address that can claim or transfer NFT (defaults to ",(0,n.jsx)(t.code,{children:"msg.sender"})," if it\u2019s not provide)"]}),"\n",(0,n.jsxs)(t.li,{children:["Alternatively, sending wstETH on behalf of ",(0,n.jsx)(t.code,{children:"WithdrawalQueueERC721.sol"})," contract can be approved in a separate upfront transaction (",(0,n.jsx)(t.code,{children:"wstETH.approve(withdrawalQueueERC721.address, allowance)"}),"), and the ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWstETH(uint256[] _amounts, address _owner)"})," method called afterwards"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"PermitInput"})," structure is defined as follows:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"struct PermitInput {\n    uint256 value;\n    uint256 deadline;\n    uint8 v;\n    bytes32 r;\n    bytes32 s;\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["After request, ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-721",children:"ERC721"})," NFT is minted to ",(0,n.jsx)(t.code,{children:"_owner"})," address and can be transferred to the other owner who will have all the rights to claim the withdrawal."]}),"\n",(0,n.jsxs)(t.p,{children:["Additionally, this NFT implements the ",(0,n.jsx)(t.a,{href:"https://eips.ethereum.org/EIPS/eip-4906",children:"ERC4906"})," standard and it's recommended to rely on"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event BatchMetadataUpdate(uint256 _fromTokenId, uint256 _toTokenId);\n"})}),"\n",(0,n.jsx)(t.p,{children:"to update the NFT metadata if you're integrating it somewhere where it should be displayed correctly."}),"\n",(0,n.jsxs)(t.admonition,{type:"note",children:[(0,n.jsxs)(t.p,{children:["Withdrawal transactions made with ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWithPermit"})," or ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWstETHWithPermit"})," might fail due to being front-run by stealing the user-provided signature to execute ",(0,n.jsx)(t.code,{children:"token.permit"})," method. It does not impose any fund loss risks nor blocks the capability to withdraw, but it affects the UX. For the details, see ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/issues/803",children:"this issue"}),"."]}),(0,n.jsxs)(t.p,{children:["It's recommended to mitigate the issue, e.g. by utilizing the approach used in ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/ethereum-staking-widget",children:"Lido staking widget"}),". Shortly, the idea is as follows. If the initial ",(0,n.jsx)(t.code,{children:"...WithPermit"})," transaction fails, immediately resent the request but via ",(0,n.jsx)(t.code,{children:"requestWithdrawals/requestWithdrawalsWstETH"})," method this time, seamlessly relying on the allowance already provided as a result of the griefing transaction.\nFor the specific example, see ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/ethereum-staking-widget/blob/ba65f2180ad0ab43b5f3bdcfeee118e6ceeabe7f/features/withdrawals/hooks/contract/useRequest.ts#L319C6-L319C6",children:"the following code"}),"."]}),(0,n.jsxs)(t.p,{children:["Any other viable approach for mitigation might be used as well. As one more example, deploy a wrapper smart contract that tries ",(0,n.jsx)(t.code,{children:"requestWithdrawalsWithPermit/requestWithdrawalsWithPermitWstETH"})," and if ",(0,n.jsx)(t.a,{href:"https://docs.soliditylang.org/en/latest/control-structures.html#try-catch",children:"catches"})," the revert error, continues with ",(0,n.jsx)(t.code,{children:"requestWithdrawals/requestWithdrawalsWstETH"}),", checking the allowance is enough."]})]}),"\n",(0,n.jsx)(t.h3,{id:"checking-the-state-of-withdrawal",children:"Checking the state of withdrawal"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["You can check all the withdrawal requests for the owner by calling ",(0,n.jsx)(t.code,{children:"getWithdrawalRequests(address _owner)"})," which returns an array of NFT ids."]}),"\n",(0,n.jsxs)(t.li,{children:["To check the state of the particular NFTs you can call ",(0,n.jsx)(t.code,{children:"getWithdrawalStatus(uint256[] _requestIds)"})," which returns an array of ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/blob/feature/shapella-upgrade/contracts/0.8.9/WithdrawalQueueBase.sol#L67-L81",children:(0,n.jsx)(t.code,{children:"WithdrawalRequestStatus"})})," struct."]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"    struct WithdrawalRequestStatus {\n        /// @notice stETH token amount that was locked on withdrawal queue for this request\n        uint256 amountOfStETH;\n        /// @notice amount of stETH shares locked on withdrawal queue for this request\n        uint256 amountOfShares;\n        /// @notice address that can claim or transfer this request\n        address owner;\n        /// @notice timestamp of when the request was created, in seconds\n        uint256 timestamp;\n        /// @notice true, if request is finalized\n        bool isFinalized;\n        /// @notice true, if request is claimed. Request is claimable if (isFinalized && !isClaimed)\n        bool isClaimed;\n    }\n"})}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"NOTE: Since stETH is an essential token if the user requests a withdrawal using wstETH directly, the amount will be nominated in stETH on request creation."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["You can call ",(0,n.jsx)(t.code,{children:"getClaimableEther(uint256[] _requestIds, uint256[] _hints)"})," to get the exact amount of eth that is reserved for the requests, where ",(0,n.jsx)(t.code,{children:"_hints"})," can be found by calling ",(0,n.jsx)(t.code,{children:"findCheckpointHints(__requestIds, 1, getLastCheckpointIndex())"}),". It will return a non-zero value only if the request is claimable (",(0,n.jsx)(t.code,{children:"isFinalized && !isClaimed"}),")"]}),"\n",(0,n.jsx)(t.h3,{id:"claiming",children:"Claiming"}),"\n",(0,n.jsx)(t.p,{children:"To claim ether you need to call:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"claimWithdrawal(uint256 _requestId)"})," with the NFT Id on behalf of the NFT owner"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"claimWithdrawals(uint256[] _requestIDs, uint256[] _hints)"})," if you want to claim multiple withdrawals in batches or optimize on hint search","\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["hints = ",(0,n.jsx)(t.code,{children:"findCheckpointHints(uint256[] calldata _requestIDs, 1, lastCheckpoint)"})]}),"\n",(0,n.jsxs)(t.li,{children:["lastCheckpoint = ",(0,n.jsx)(t.code,{children:"getLastCheckpointIndex()"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"general-integration-examples",children:"General integration examples"}),"\n",(0,n.jsx)(t.h3,{id:"stethwsteth-as-collateral",children:"stETH/wstETH as collateral"}),"\n",(0,n.jsx)(t.p,{children:"stETH/wstETH as DeFi collateral is beneficial for several reasons:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"stETH/wstETH is almost as safe as ether, price-wise: barring catastrophic scenarios, its value tends to hold the ETH 1:1 well;"}),"\n",(0,n.jsx)(t.li,{children:"stETH/wstETH is a productive token: getting rewards on collateral effectively lowers the cost of borrowing;"}),"\n",(0,n.jsxs)(t.li,{children:["stETH/wstETH is a very liquid token with billions of liquidity locked in liquidity pools (see ",(0,n.jsx)(t.a,{href:"#sttokens-steth-and-wsteth",children:"above"}),")"]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Lido's staked tokens have been listed on major liquidity protocols:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["On Maker, ",(0,n.jsx)(t.a,{href:"https://daistats.com/#/collateral",children:"wstETH collateral (scroll down to Dai from WSTETH-A section)"})," can be used to mint DAI stablecoin. See ",(0,n.jsx)(t.a,{href:"https://blog.lido.fi/makerdao-integrates-lidos-staked-eth-steth-as-collateral-asset/",children:"Lido's blog post"})," for more details."]}),"\n",(0,n.jsxs)(t.li,{children:["On AAVE v3, multiple tokens can be borrowed against wstETH on various chains (see the list of the ",(0,n.jsx)(t.a,{href:"#sttokens-steth-and-wsteth",children:"markets"}),")"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Robust price sources are required for listing on most money markets, with ChainLink price feeds being the industry standard.\nThe default option to use is exchange ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/guides/lido-tokens-integration-guide#sttokens-steth-and-wsteth",children:"rate feeds"})," with an option to compose arbitrary feeds:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"'wstETH/X price feed' = 'wstETH/stETH rate feed' \xd7 'ETH/X price feed'\n"})}),"\n",(0,n.jsx)(t.h3,{id:"wallet-integrations",children:"Wallet integrations"}),"\n",(0,n.jsx)(t.p,{children:"Lido's Ethereum staking services have been successfully integrated into the most popular DeFi wallets, including Ledger, Metamask, MyEtherWallet, ImToken and others.\nHaving stETH integrated can provide wallet users with a great user experience of direct staking from the wallet UI itself."}),"\n",(0,n.jsx)(t.p,{children:"When adding stETH support to a DeFi wallet, it is important to preserve stETH's rebasing nature.\nNote that stETH balance changes on each rebase without any incoming or outgoing user transfers and does not emit ERC-20 'Transfer' events.\nAs a consequence, avoid storing cached stETH balance for extended periods of time (over 24 hours)."}),"\n",(0,n.jsxs)(t.p,{children:["The integration might be implemented leveraging the ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/integrations/sdk#lido-ethereum-sdk",children:"Lido on Ethereum SDK"})]}),"\n",(0,n.jsx)(t.h3,{id:"cross-chain-bridging",children:"Cross chain bridging"}),"\n",(0,n.jsxs)(t.p,{children:["The Lido's wstETH gets bridged to various L2's and sidechains.\nThe process of a new network adoption in a future-proof way is outlined as a part of the separate ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/token-guides/wsteth-bridging-guide",children:"bridging guide"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"Most cross-chain token bridges have no mechanics to handle rebases.\nThis means bridging stETH to other chains will prevent stakers from collecting their staking rewards."}),"\n",(0,n.jsx)(t.admonition,{type:"warning",children:(0,n.jsx)(t.p,{children:"In the most common case, the rewards will naturally go to the bridge smart contract becoming locked there and never make it to the stakers."})}),"\n",(0,n.jsx)(t.p,{children:"While working on full-blown bridging solutions, the Lido contributors encourage the users to only bridge the non-rebasable representation of staked ether, namely wstETH."}),"\n",(0,n.jsx)(t.h2,{id:"risks",children:"Risks"}),"\n",(0,n.jsx)(t.p,{children:"There exist a number of potential risks when staking using liquid staking protocols."}),"\n",(0,n.jsx)(t.h3,{id:"smart-contract-security",children:"Smart contract security"}),"\n",(0,n.jsx)(t.p,{children:"There is an inherent risk that Lido could contain a smart contract vulnerability or bug. The Lido code is open-source, audited, and covered by an extensive bug bounty program to minimize this risk. To mitigate smart contract risks, all of the core Lido contracts are audited. Audit reports can be found here. Besides, Lido is covered with a massive Immunefi bug bounty program."}),"\n",(0,n.jsx)(t.h3,{id:"slashing-risk",children:"Slashing risk"}),"\n",(0,n.jsx)(t.p,{children:"Validators risk staking penalties, with up to 100% of staked funds at risk if validators fail. To minimize this risk, Lido stakes across multiple professional and reputable node operators with heterogeneous setups, with additional mitigation in the form of self-coverage."}),"\n",(0,n.jsx)(t.h3,{id:"sttoken-price-risk",children:"stToken price risk"}),"\n",(0,n.jsx)(t.p,{children:"Users risk an exchange price of stTokens which is lower than inherent value due to withdrawal restrictions on Lido, making arbitrage and risk-free market-making impossible. The Lido DAO is driven to mitigate the above risks to the extent possible. Despite this, they may still exist and, as such, it is our duty to communicate them."}),"\n",(0,n.jsx)(t.p,{children:"The Lido DAO is driven to mitigate the above risks to the extent possible. Despite this, they may still exist."})]})}function c(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>o});var n=s(6540);const i={},a=n.createContext(i);function r(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);