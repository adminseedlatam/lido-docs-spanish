"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[1685],{5027:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var n=s(4848),r=s(8453);const a={},i="AccountingOracle",o={id:"contracts/accounting-oracle",title:"AccountingOracle",description:"- Source code",source:"@site/docs/contracts/accounting-oracle.md",sourceDirName:"contracts",slug:"/contracts/accounting-oracle",permalink:"/lido-docs-spanish/contracts/accounting-oracle",draft:!1,unlisted:!1,editUrl:"https://github.com/adminseedlatam/lido-docs-spanish/edit/main/docs/contracts/accounting-oracle.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"EIP712StETH",permalink:"/lido-docs-spanish/contracts/eip712-steth"},next:{title:"ValidatorsExitBusOracle",permalink:"/lido-docs-spanish/contracts/validators-exit-bus-oracle"}},d={},c=[{value:"What is AccountingOracle",id:"what-is-accountingoracle",level:2},{value:"Report cycle",id:"report-cycle",level:2},{value:"Report processing",id:"report-processing",level:2},{value:"Report data",id:"report-data",level:2},{value:"Extra data",id:"extra-data",level:5},{value:"Access and permissioms",id:"access-and-permissioms",level:2},{value:"Constants",id:"constants",level:2},{value:"LIDO()",id:"lido",level:3},{value:"LOCATOR()",id:"locator",level:3},{value:"LEGACY_ORACLE()",id:"legacy_oracle",level:3},{value:"SECONDS_PER_SLOT()",id:"seconds_per_slot",level:3},{value:"GENESIS_TIME()",id:"genesis_time",level:3},{value:"EXTRA_DATA_TYPE_STUCK_VALIDATORS()",id:"extra_data_type_stuck_validators",level:3},{value:"EXTRA_DATA_TYPE_EXITED_VALIDATORS()",id:"extra_data_type_exited_validators",level:3},{value:"EXTRA_DATA_FORMAT_EMPTY()",id:"extra_data_format_empty",level:3},{value:"EXTRA_DATA_FORMAT_LIST()",id:"extra_data_format_list",level:3},{value:"ProcessingState",id:"processingstate",level:2},{value:"View methods",id:"view-methods",level:2},{value:"getConsensusContract()",id:"getconsensuscontract",level:3},{value:"getConsensusReport()",id:"getconsensusreport",level:3},{value:"Returns",id:"returns",level:4},{value:"getConsensusVersion()",id:"getconsensusversion",level:3},{value:"getContractVersion()",id:"getcontractversion",level:3},{value:"getLastProcessingRefSlot()",id:"getlastprocessingrefslot",level:3},{value:"getProcessingState()",id:"getprocessingstate",level:3},{value:"Methods",id:"methods",level:2},{value:"submitReportData()",id:"submitreportdata",level:3},{value:"Parameters",id:"parameters",level:4},{value:"Reverts",id:"reverts",level:4},{value:"submitReportExtraDataEmpty()",id:"submitreportextradataempty",level:3},{value:"Reverts",id:"reverts-1",level:4},{value:"submitReportExtraDataList()",id:"submitreportextradatalist",level:3},{value:"Parameters",id:"parameters-1",level:4},{value:"Reverts",id:"reverts-2",level:4},{value:"submitConsensusReport()",id:"submitconsensusreport",level:3},{value:"Parameters",id:"parameters-2",level:4},{value:"discardConsensusReport()",id:"discardconsensusreport",level:3},{value:"setConsensusContract()",id:"setconsensuscontract",level:3},{value:"setConsensusVersion()",id:"setconsensusversion",level:3},{value:"Permissions",id:"permissions",level:2},{value:"SUBMIT_DATA_ROLE()",id:"submit_data_role",level:3},{value:"MANAGE_CONSENSUS_CONTRACT_ROLE()",id:"manage_consensus_contract_role",level:3},{value:"MANAGE_CONSENSUS_VERSION_ROLE()",id:"manage_consensus_version_role",level:3},{value:"Events",id:"events",level:2},{value:"ExtraDataSubmitted()",id:"extradatasubmitted",level:3},{value:"WarnExtraDataIncompleteProcessing()",id:"warnextradataincompleteprocessing",level:3},{value:"ConsensusHashContractSet()",id:"consensushashcontractset",level:3},{value:"ConsensusVersionSet()",id:"consensusversionset",level:3},{value:"ReportSubmitted()",id:"reportsubmitted",level:3},{value:"ReportDiscarded()",id:"reportdiscarded",level:3},{value:"ProcessingStarted()",id:"processingstarted",level:3},{value:"WarnProcessingMissed()",id:"warnprocessingmissed",level:3},{value:"Reverts",id:"reverts-3",level:2},{value:"submitReportData()",id:"submitreportdata-1",level:3},{value:"AccountingOracle and BaseOracle contracts",id:"accountingoracle-and-baseoracle-contracts",level:4},{value:"OracleReportSanityChecker",id:"oraclereportsanitychecker",level:4},{value:"StakingRouter",id:"stakingrouter",level:4}];function l(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"accountingoracle",children:"AccountingOracle"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/blob/master/contracts/0.8.9/oracle/AccountingOracle.sol",children:"Source code"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://etherscan.io/address/0x852deD011285fe67063a08005c71a85690503Cee",children:"Deployed contract"})}),"\n",(0,n.jsxs)(t.li,{children:["Inherits ",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/blob/master/contracts/0.8.9/oracle/BaseOracle.sol",children:"BaseOracle"})]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsxs)(t.p,{children:["It's advised to read ",(0,n.jsx)(t.a,{href:"/guides/oracle-operator-manual#intro",children:"What is Lido Oracle mechanism"})," before"]})}),"\n",(0,n.jsx)(t.h2,{id:"what-is-accountingoracle",children:"What is AccountingOracle"}),"\n",(0,n.jsxs)(t.p,{children:["AccountingOracle is a contract which collects information submitted by the off-chain oracles about state of the Lido-participating validators and their balances, the\namount of funds accumulated on the protocol vaults (i.e., ",(0,n.jsx)(t.a,{href:"./withdrawal-vault",children:"withdrawal"})," and ",(0,n.jsx)(t.a,{href:"./lido-execution-layer-rewards-vault",children:"execution layer rewards"})," vaults), the number ",(0,n.jsx)(t.a,{href:"./staking-router#exited-and-stuck-validators",children:"exited and stuck"})," validators, the number of ",(0,n.jsx)(t.a,{href:"./withdrawal-queue-erc721#request",children:"withdrawal requests"})," the protocol is able to process and distributes node-operator rewards."]}),"\n",(0,n.jsx)(t.h2,{id:"report-cycle",children:"Report cycle"}),"\n",(0,n.jsx)(t.p,{children:"The oracle work is delineated by equal time periods called frames. In normal operation, oracles finalize a report in each frame (the frame duration is 225 Ethereum Consensus Layer epochs, each frame starts at ~12:00 noon UTC). Each frame has a reference slot and processing deadline. Report data is gathered by looking at the world state (both Ethereum Execution and Consensus Layers) at the moment of the frame's reference slot (including any state changes made in that slot), and must be processed before the frame's processing deadline."}),"\n",(0,n.jsx)(t.p,{children:"Reference slot for each frame is set to the last slot of the epoch preceding the frame's first epoch. The processing deadline is set to the last slot of the last epoch of the frame."}),"\n",(0,n.jsxs)(t.p,{children:["It's worth noting that frame length ",(0,n.jsx)(t.a,{href:"./hash-consensus#setframeconfig",children:"can be changed"}),". And if oracle report is delayed it does not extend the report period, unless it's missed. In this case, the next report will have the report period increased."]}),"\n",(0,n.jsx)(t.p,{children:"The frame includes these stages:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Waiting:"})," oracle starts as a ",(0,n.jsx)(t.a,{href:"/guides/oracle-operator-manual#the-oracle-daemon",children:"daemon"})," and wakes up every 12 seconds (by default) in order to find the last finalized slot, trying to collate with it with the expected reference slot;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Data collection:"})," oracles monitor the state of both the execution and consensus layers and collect the data for the successfully arrived finalized reference slot;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Hash consensus:"})," oracles analyze the data, compile the report and submit its hash to the ",(0,n.jsx)(t.a,{href:"./hash-consensus",children:(0,n.jsx)(t.code,{children:"HashConsensus"})})," smart contract;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Core update report:"})," once the ",(0,n.jsx)(t.a,{href:"./hash-consensus#getquorum",children:"quorum"})," of hashes is reached, meaning more than half of the oracles submitted the same hash (i.e., 5 of 9 oracle committee members at the moment of writing), one of the oracles chosen in turn submits the actual report to the ",(0,n.jsx)(t.code,{children:"AccountingOracle"})," contract, which triggers the core protocol state update, including the token rebase, distribution of node operator rewards, finalization of withdrawal requests, and the protocol mode decision: whether to go in the bunker mode, and"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Extra data report:"})," an additional report carrying additional information that is not vital for the core update is submitted to the AccountingOracle, can be submitted in chunks (e.g, node operator key states and reward distribution data)."]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["As it was said, daily oracle reports shouldn't be taken for granted.\nOracle daemons could stop pushing their reports for extended periods of time in case of no\n",(0,n.jsx)(t.a,{href:"https://ethereum.org/en/developers/docs/consensus-mechanisms/pos/#finality",children:"finality"})," on the Ethereum Consensus Layer.\nThis would ultimately result in no oracle reports and no stETH rebases for this whole period."]})}),"\n",(0,n.jsx)(t.h2,{id:"report-processing",children:"Report processing"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"./accounting-oracle#submitreportdata",children:"submission"})," of the main report to ",(0,n.jsx)(t.code,{children:"AccountingOracle"})," triggers the next processes in order, although within a single tx:"]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Update exited validators counts for each StakingModule in StakingRouter;"}),"\n",(0,n.jsx)(t.li,{children:"Update bunker mode status for WithdrawalQueue;"}),"\n",(0,n.jsx)(t.li,{children:"Handle function on the Lido contract which performs the main protocol state change."}),"\n",(0,n.jsx)(t.li,{children:"Store information about ExtraData"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The diagram shows the interaction with contracts."}),"\n",(0,n.jsx)(t.mermaid,{value:"graph LR;\n  A[/  \\]--submitReportData--\x3eAccountingOracle--handleConsensusLayerReport---\x3eLegacyOracle;\n  AccountingOracle--handleOracleReport--\x3eLido--handlePostTokenRebase--\x3eLegacyOracle\n  AccountingOracle--checkAccountingExtraDataListItemsCount--\x3eOracleReportSanityChecker;\n  AccountingOracle--updateExitedValidatorsCountByStakingModule--\x3eStakingRouter;\n  AccountingOracle--checkExitedValidatorsRatePerDay--\x3eOracleReportSanityChecker;\n  AccountingOracle--'onOracleReport'--\x3eWithdrawalQueue;"}),"\n",(0,n.jsx)(t.h2,{id:"report-data",children:"Report data"}),"\n",(0,n.jsxs)(t.p,{children:["The function ",(0,n.jsx)(t.code,{children:"submitReportData()"})," accepts the following ",(0,n.jsx)(t.code,{children:"ReportData"})," structure."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"struct ReportData {\n    uint256 consensusVersion;\n    uint256 refSlot;\n    uint256 numValidators;\n    uint256 clBalanceGwei;\n    uint256[] stakingModuleIdsWithNewlyExitedValidators;\n    uint256[] numExitedValidatorsByStakingModule;\n    uint256 withdrawalVaultBalance;\n    uint256 elRewardsVaultBalance;\n    uint256 sharesRequestedToBurn;\n    uint256[] withdrawalFinalizationBatches;\n    uint256 simulatedShareRate;\n    bool isBunkerMode;\n    uint256 extraDataFormat;\n    bytes32 extraDataHash;\n    uint256 extraDataItemsCount;\n}\n"})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"Oracle consensus info"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"consensusVersion"})," \u2014 Version of the oracle consensus rules. A current version expected by the oracle can be obtained by calling ",(0,n.jsx)(t.code,{children:"getConsensusVersion()"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"refSlot"})," \u2014 Reference slot for which the report was calculated. The state being reported must include all state changes resulting from the all blocks up to this reference slot (inclusive). The epoch containing the slot must be finalized prior to calculating the report."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"CL values"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"numValidators"})," \u2014 The number of validators on the Ethereum Consensus Layer that were ever deposited via Lido as observed at the reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"clBalanceGwei"})," \u2014 Cumulative balance nominated in gwei of all Lido validators on the Ethereum Consensus Layer as observed at the reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"stakingModuleIdsWithNewlyExitedValidators"})," \u2014 Ids of staking modules that have more exited validators than the number stored in the respective staking module contract as observed at the reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"numExitedValidatorsByStakingModule"})," \u2014 Number of ever exited validators for each of the staking modules from the ",(0,n.jsx)(t.code,{children:"stakingModuleIdsWithNewlyExitedValidators"})," array as observed at the reference slot."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"EL values"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"withdrawalVaultBalance"})," \u2014 Ether balance of the Lido ",(0,n.jsx)(t.a,{href:"/contracts/withdrawal-vault",children:"withdrawal vault"})," as observed at the reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"elRewardsVaultBalance"})," \u2014 Ether balance of the Lido ",(0,n.jsx)(t.a,{href:"/contracts/lido-execution-layer-rewards-vault",children:"execution layer rewards vault"})," as observed at the reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"sharesRequestedToBurn"})," \u2014 The shares amount requested to burn through ",(0,n.jsx)(t.a,{href:"/contracts/burner",children:"Burner"})," as observed at the reference slot. The value can be obtained in the following way:"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"(coverSharesToBurn, nonCoverSharesToBurn) = IBurner(burner).getSharesRequestedToBurn()\nsharesRequestedToBurn = coverSharesToBurn + nonCoverSharesToBurn\n"})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"Withdrawals finalization decision"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"withdrawalFinalizationBatches"})," \u2014 The ascendingly-sorted array of withdrawal request IDs obtained by the oracle daemon on report gathering via calling ",(0,n.jsx)(t.a,{href:"./withdrawal-queue-erc721#calculatefinalizationbatches",children:(0,n.jsx)(t.code,{children:"WithdrawalQueue.calculateFinalizationBatches"})}),". An empty array means that no withdrawal requests to be finalized."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"simulatedShareRate"})," \u2014 The share rate (i.e., ",(0,n.jsx)(t.a,{href:"./lido#gettotalpooledether",children:"total pooled ether"})," divided by ",(0,n.jsx)(t.a,{href:"./lido#gettotalshares",children:"total shares"}),") with the 10^27 precision (i.e., multiplied by 10^27) that would be effective as the result of applying this oracle report at the reference slot, with ",(0,n.jsx)(t.code,{children:"withdrawalFinalizationBatches"})," set to empty array and ",(0,n.jsx)(t.code,{children:"simulatedShareRate"})," set to 0. To estimate ",(0,n.jsx)(t.code,{children:"simulatedShareRate"})," one should perform a view call ",(0,n.jsx)(t.a,{href:"/contracts/lido#handleoraclereport",children:"Lido.handleOracleReport"})," directly via ",(0,n.jsx)(t.a,{href:"https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_call",children:(0,n.jsx)(t.code,{children:"eth_call"})})," JSON-RPC API and calculate as follows:"]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"_simulatedShareRate = (postTotalPooledEther * 10**27) / postTotalShares\n"})}),"\n",(0,n.jsxs)(t.p,{children:["where ",(0,n.jsx)(t.code,{children:"postTotalPooledEther"})," and ",(0,n.jsx)(t.code,{children:"postTotalShares"})," were retrieved as return values from the performed view call"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"isBunkerMode"})," \u2014 Whether, based on the state observed at the reference slot, the protocol must be in the bunker mode or the turbo (regular) mode."]}),"\n"]}),"\n",(0,n.jsxs)(t.admonition,{type:"note",children:[(0,n.jsx)(t.h5,{id:"extra-data",children:"Extra data"}),(0,n.jsx)(t.p,{children:"Extra data \u2014 the oracle information that allows asynchronous processing, potentially in\nchunks, after the main data is processed. The oracle doesn't enforce that extra data\nattached to the same data report is processed in full before the processing deadline expires\nor a new data report starts being processed, but enforces that no processing of extra\ndata for a report is possible after its processing deadline passes or a new data report\narrives."}),(0,n.jsx)(t.p,{children:"Extra data is an array of items, each item being encoded as follows:"}),(0,n.jsx)(t.p,{children:"3 bytes    2 bytes      X bytes\n| itemIndex | itemType | itemPayload |"}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"itemIndex"})," is a 0-based index into the extra data array;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"itemType"})," is the type of extra data item;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"itemPayload"})," is the item's data which interpretation depends on the item's type."]}),"\n"]}),(0,n.jsxs)(t.p,{children:["Items must be sorted ascendingly by the ",(0,n.jsx)(t.code,{children:"(itemType, ...itemSortingKey)"})," compound key\nwhere ",(0,n.jsx)(t.code,{children:"itemSortingKey"})," calculation depends on the item's type (see below)."]}),(0,n.jsx)(t.hr,{}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:(0,n.jsx)(t.code,{children:"itemType=0"})})," (",(0,n.jsx)(t.code,{children:"EXTRA_DATA_TYPE_STUCK_VALIDATORS"}),"): stuck validators by node operators."]}),(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"itemPayload"})," field has the following format:"]}),(0,n.jsx)(t.p,{children:"| 3 bytes  |   8 bytes    |  nodeOpsCount * 8 bytes  |  nodeOpsCount * 16 bytes  |\n| moduleId | nodeOpsCount |      nodeOperatorIds     |   stuckValidatorsCounts   |"}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"moduleId"})," is the staking module for which exited keys counts are being reported."]}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"nodeOperatorIds"})," contains an array of ids of node operators that have total stuck\nvalidators counts changed compared to the staking module smart contract storage as\nobserved at the reference slot. Each id is a 8-byte uint, ids are packed tightly."]}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"nodeOpsCount"})," contains the number of node operator ids contained in the nodeOperatorIds\narray. Thus,"]}),(0,n.jsx)(t.p,{children:"nodeOpsCount = byteLength(nodeOperatorIds) / 8"}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"stuckValidatorsCounts"})," contains an array of stuck validators total counts, as observed at\nthe reference slot, for the node operators from the nodeOperatorIds array, in the same\norder. Each count is a 16-byte uint, counts are packed tightly. Thus,"]}),(0,n.jsx)(t.p,{children:"byteLength(stuckValidatorsCounts) = nodeOpsCount * 16"}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"nodeOpsCount"})," must not be greater than ",(0,n.jsx)(t.code,{children:"maxAccountingExtraDataListItemsCount"})," specified\nin the ",(0,n.jsx)(t.a,{href:"./oracle-report-sanity-checker",children:(0,n.jsx)(t.code,{children:"OracleReportSanityChecker"})})," contract. If a staking module has more node operators\nwith total stuck validators counts changed compared to the staking module smart contract\nstorage (as observed at the reference slot), reporting for that module should be split\ninto multiple items."]}),(0,n.jsx)(t.p,{children:"Item sorting key is a compound key consisting of the module id and the first reported\nnode operator's id:"}),(0,n.jsx)(t.p,{children:"itemSortingKey = (moduleId, nodeOperatorIds[0:8])"}),(0,n.jsx)(t.hr,{}),(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:(0,n.jsx)(t.code,{children:"itemType=1"})})," (",(0,n.jsx)(t.code,{children:"EXTRA_DATA_TYPE_EXITED_VALIDATORS"}),"): exited validators by node operators."]}),(0,n.jsxs)(t.p,{children:["The payload format is exactly the same as for ",(0,n.jsx)(t.code,{children:"itemType=EXTRA_DATA_TYPE_STUCK_VALIDATORS"}),",\nexcept that, instead of stuck validators counts, exited validators counts are reported.\nThe ",(0,n.jsx)(t.code,{children:"itemSortingKey"})," is calculated identically."]}),(0,n.jsx)(t.hr,{}),(0,n.jsxs)(t.p,{children:["The oracle daemon must report exited/stuck validators counts ONLY for those\n",(0,n.jsx)(t.code,{children:"(moduleId, nodeOperatorId)"})," pairs that contain outdated counts in the staking\nmodule smart contract as observed at the reference slot."]}),(0,n.jsx)(t.p,{children:"Extra data array can be passed in different formats, see below."})]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataFormat"})," -  Format of the extra data. Currently, only the ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_EMPTY=0"})," and ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_LIST=1"})," formats are supported. See the constant defining a specific data format for more info."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataHash"})," - Hash of the extra data. See the constant defining a specific extra data format for the info on how to calculate the hash. Must be set to a zero hash if the oracle report contains no extra data."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataItemsCount"})," - Number of the extra data items. Must be set to zero if the oracle report contains no extra data."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"access-and-permissioms",children:"Access and permissioms"}),"\n",(0,n.jsxs)(t.p,{children:["Access to lever methods is restricted using the functionality of the\n",(0,n.jsx)(t.a,{href:"https://github.com/lidofinance/lido-dao/blob/master/contracts/0.8.9/utils/access/AccessControlEnumerable.sol",children:"AccessControlEnumerable"}),"\ncontract and a bunch of ",(0,n.jsx)(t.a,{href:"#permissions",children:"granular roles"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"constants",children:"Constants"}),"\n",(0,n.jsx)(t.h3,{id:"lido",children:"LIDO()"}),"\n",(0,n.jsxs)(t.p,{children:["Returns an address of the ",(0,n.jsx)(t.a,{href:"/contracts/lido",children:"Lido"})," contract"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"address public immutable LIDO\n"})}),"\n",(0,n.jsx)(t.h3,{id:"locator",children:"LOCATOR()"}),"\n",(0,n.jsxs)(t.p,{children:["Returns an address of the ",(0,n.jsx)(t.a,{href:"/contracts/lido-locator",children:"LidoLocator"})," contract"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"ILidoLocator public immutable LOCATOR\n"})}),"\n",(0,n.jsx)(t.h3,{id:"legacy_oracle",children:"LEGACY_ORACLE()"}),"\n",(0,n.jsxs)(t.p,{children:["Returns an address of the ",(0,n.jsx)(t.a,{href:"/contracts/legacy-oracle",children:"LegacyOracle"})," contract"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"address public immutable LEGACY_ORACLE\n"})}),"\n",(0,n.jsx)(t.h3,{id:"seconds_per_slot",children:"SECONDS_PER_SLOT()"}),"\n",(0,n.jsxs)(t.p,{children:["See ",(0,n.jsx)(t.a,{href:"https://ethereum.org/en/developers/docs/blocks/#block-time",children:"https://ethereum.org/en/developers/docs/blocks/#block-time"})]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["always returns 12 seconds due to ",(0,n.jsx)(t.a,{href:"https://ethereum.org/en/roadmap/merge/",children:"the Merge"})]})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public immutable SECONDS_PER_SLOT\n"})}),"\n",(0,n.jsx)(t.h3,{id:"genesis_time",children:"GENESIS_TIME()"}),"\n",(0,n.jsxs)(t.p,{children:["See ",(0,n.jsx)(t.a,{href:"https://blog.ethereum.org/2020/11/27/eth2-quick-update-no-21",children:"https://blog.ethereum.org/2020/11/27/eth2-quick-update-no-21"})]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["always returns 1606824023 (December 1, 2020, 12:00:23pm UTC) on ",(0,n.jsx)(t.a,{href:"https://blog.ethereum.org/2020/11/27/eth2-quick-update-no-21",children:"Mainnet"})]})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public immutable GENESIS_TIME\n"})}),"\n",(0,n.jsx)(t.h3,{id:"extra_data_type_stuck_validators",children:"EXTRA_DATA_TYPE_STUCK_VALIDATORS()"}),"\n",(0,n.jsxs)(t.p,{children:["This type carries the details of ",(0,n.jsx)(t.a,{href:"/contracts/staking-router#exited-and-stuck-validators",children:"stuck"})," validator(s)."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public constant EXTRA_DATA_TYPE_STUCK_VALIDATORS = 1\n"})}),"\n",(0,n.jsx)(t.h3,{id:"extra_data_type_exited_validators",children:"EXTRA_DATA_TYPE_EXITED_VALIDATORS()"}),"\n",(0,n.jsxs)(t.p,{children:["This type contains the details of ",(0,n.jsx)(t.a,{href:"/contracts/staking-router#exited-and-stuck-validators",children:"exited"})," validator(s)."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public constant EXTRA_DATA_TYPE_EXITED_VALIDATORS = 2\n"})}),"\n",(0,n.jsx)(t.h3,{id:"extra_data_format_empty",children:"EXTRA_DATA_FORMAT_EMPTY()"}),"\n",(0,n.jsxs)(t.p,{children:["The extra data format used to signify that the oracle report contains no ",(0,n.jsx)(t.a,{href:"/contracts/accounting-oracle#extra-data",children:"extra data"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["Sends as a part of the Oracle's ",(0,n.jsx)(t.a,{href:"/guides/oracle-operator-manual#phase-3-submitting-a-report-extra-data",children:"Phase 3"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["This format uses when there are no new ",(0,n.jsx)(t.a,{href:"/contracts/staking-router#exited-and-stuck-validators",children:"stuck"})," or ",(0,n.jsx)(t.a,{href:"/contracts/staking-router#exited-and-stuck-validators",children:"exited"})," validators on report period."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public constant EXTRA_DATA_FORMAT_EMPTY = 0\n"})}),"\n",(0,n.jsx)(t.h3,{id:"extra_data_format_list",children:"EXTRA_DATA_FORMAT_LIST()"}),"\n",(0,n.jsx)(t.p,{children:"The list format for the extra data array. Used when all extra data processing\nfits into a single transaction."}),"\n",(0,n.jsx)(t.p,{children:"Extra data is passed within a single transaction as a bytearray containing all data items\npacked tightly."}),"\n",(0,n.jsxs)(t.p,{children:["Hash is a ",(0,n.jsx)(t.code,{children:"keccak256"})," hash calculated over the bytearray items. The Solidity equivalent of\nthe hash calculation code would be ",(0,n.jsx)(t.code,{children:"keccak256(array)"}),", where ",(0,n.jsx)(t.code,{children:"array"})," has the ",(0,n.jsx)(t.code,{children:"bytes"})," type."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"uint256 public constant EXTRA_DATA_FORMAT_LIST = 1\n"})}),"\n",(0,n.jsx)(t.h2,{id:"processingstate",children:"ProcessingState"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"struct ProcessingState {\n    uint256 currentFrameRefSlot;\n    uint256 processingDeadlineTime;\n    bytes32 mainDataHash;\n    bool mainDataSubmitted;\n    bytes32 extraDataHash;\n    uint256 extraDataFormat;\n    bool extraDataSubmitted;\n    uint256 extraDataItemsCount;\n    uint256 extraDataItemsSubmitted;\n}\n"})}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"currentFrameRefSlot"})," - Reference slot for the current reporting frame."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"processingDeadlineTime"})," - The last time at which a data can be submitted for the current reporting frame."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"mainDataHash"})," - Hash of the main report data. Zero bytes if consensus on the hash hasn't been reached yet for the current reporting frame."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"mainDataSubmitted"})," - Whether the main report data for the current reporting frame has already been submitted."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataHash"})," - Hash of the extra report data. Should be ignored unless ",(0,n.jsx)(t.code,{children:"mainDataSubmitted"})," is true."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataFormat"})," - Format of the extra report data for the current reporting frame. Should be ignored unless ",(0,n.jsx)(t.code,{children:"mainDataSubmitted"})," is true."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataSubmitted"})," - Total number of extra report data items for the current reporting frame. Should be ignored unless ",(0,n.jsx)(t.code,{children:"mainDataSubmitted"})," is true."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"extraDataItemsSubmitted"})," - How many extra report data items are already submitted for the current reporting frame."]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"view-methods",children:"View methods"}),"\n",(0,n.jsx)(t.h3,{id:"getconsensuscontract",children:"getConsensusContract()"}),"\n",(0,n.jsxs)(t.p,{children:["Returns the address of the ",(0,n.jsx)(t.a,{href:"/contracts/hash-consensus",children:"HashConsensus"})," contract instance used by ",(0,n.jsx)(t.code,{children:"AccountingOracle"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getConsensusContract() external view returns (address)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"getconsensusreport",children:"getConsensusReport()"}),"\n",(0,n.jsx)(t.p,{children:"Returns the last consensus report hash and metadata."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getConsensusReport() external view returns (\n    bytes32 hash,\n    uint256 refSlot,\n    uint256 processingDeadlineTime,\n    bool processingStarted\n)\n"})}),"\n",(0,n.jsx)(t.h4,{id:"returns",children:"Returns"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Name"}),(0,n.jsx)(t.th,{children:"Type"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"hash"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"bytes32"})}),(0,n.jsx)(t.td,{children:"The last reported hash"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"refSlot"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"uint256"})}),(0,n.jsx)(t.td,{children:"The frame's reference slot: if the data the consensus is being reached upon includes or depends on any onchain state, this state should be queried at the reference slot. The state being reported must include all state changes resulting from all blocks up to this reference slot (inclusive)."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"processingDeadlineTime"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"uint256"})}),(0,n.jsx)(t.td,{children:"Timestamp of the last slot at which a report can be reported and processed"})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"processingStarted"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"bool"})}),(0,n.jsx)(t.td,{children:"Has the processing of the report been started or not"})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"getconsensusversion",children:"getConsensusVersion()"}),"\n",(0,n.jsx)(t.p,{children:"Returns the current consensus version expected by the oracle contract."}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsx)(t.p,{children:"Consensus version must change every time consensus rules change, meaning that\nan oracle looking at the same reference slot would calculate a different hash."})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getConsensusVersion() external view returns (uint256)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"getcontractversion",children:"getContractVersion()"}),"\n",(0,n.jsx)(t.p,{children:"Returns the current contract version."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getContractVersion() public view returns (uint256)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"getlastprocessingrefslot",children:"getLastProcessingRefSlot()"}),"\n",(0,n.jsx)(t.p,{children:"Returns the last reference slot for which processing of the report was started."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getLastProcessingRefSlot() external view returns (uint256)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"getprocessingstate",children:"getProcessingState()"}),"\n",(0,n.jsxs)(t.p,{children:["Returns data processing state for the current reporting frame. See the docs for the ",(0,n.jsx)(t.a,{href:"#processingstate",children:"ProcessingState"})," struct."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function getProcessingState() external view returns (ProcessingState memory result)\n"})}),"\n",(0,n.jsx)(t.h2,{id:"methods",children:"Methods"}),"\n",(0,n.jsx)(t.h3,{id:"submitreportdata",children:"submitReportData()"}),"\n",(0,n.jsx)(t.p,{children:"Submits report data for processing."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function submitReportData(ReportData calldata data, uint256 contractVersion)\n"})}),"\n",(0,n.jsx)(t.h4,{id:"parameters",children:"Parameters"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Name"}),(0,n.jsx)(t.th,{children:"Type"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"data"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"ReportData"})}),(0,n.jsxs)(t.td,{children:["The data. See the ",(0,n.jsx)(t.a,{href:"./accounting-oracle#report-data",children:"ReportData"})," structure's docs for details."]})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"contractVersion"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"uint256"})}),(0,n.jsx)(t.td,{children:"Expected version of the oracle contract."})]})]})]}),"\n",(0,n.jsx)(t.h4,{id:"reverts",children:"Reverts"}),"\n",(0,n.jsxs)(t.p,{children:["For more information about reverts, see a separate section ",(0,n.jsx)(t.a,{href:"#reverts-3",children:"here"})]}),"\n",(0,n.jsx)(t.h3,{id:"submitreportextradataempty",children:"submitReportExtraDataEmpty()"}),"\n",(0,n.jsx)(t.p,{children:"Triggers the processing required when no extra data is present in the report, i.e. when extra data format equals EXTRA_DATA_FORMAT_EMPTY."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function submitReportExtraDataEmpty()\n"})}),"\n",(0,n.jsx)(t.h4,{id:"reverts-1",children:"Reverts"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"SenderNotAllowed()"})," if sender doesn't have a ",(0,n.jsx)(t.code,{children:"SUBMIT_DATA_ROLE"})," role and sender is not a consensus member."]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"submitreportextradatalist",children:"submitReportExtraDataList()"}),"\n",(0,n.jsx)(t.p,{children:"Submits report extra data in the EXTRA_DATA_FORMAT_LIST format for processing."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function submitReportExtraDataList(bytes calldata items)\n"})}),"\n",(0,n.jsx)(t.h4,{id:"parameters-1",children:"Parameters"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Name"}),(0,n.jsx)(t.th,{children:"Type"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsx)(t.tbody,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"items"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"bytes"})}),(0,n.jsxs)(t.td,{children:["The extra data items list. See docs for the ",(0,n.jsx)(t.a,{href:"#extra_data_format_list",children:"EXTRA_DATA_FORMAT_LIST"})," constant for details."]})]})})]}),"\n",(0,n.jsx)(t.h4,{id:"reverts-2",children:"Reverts"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"SenderNotAllowed()"})," if sender doesn't have a ",(0,n.jsx)(t.code,{children:"SUBMIT_DATA_ROLE"})," role and sender is not a consensus member."]}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"submitconsensusreport",children:"submitConsensusReport()"}),"\n",(0,n.jsxs)(t.p,{children:["Called by ",(0,n.jsx)(t.a,{href:"/contracts/hash-consensus",children:"AccountingOracle HashConsensus"})," contract to push a consensus report for processing."]}),"\n",(0,n.jsx)(t.admonition,{type:"note",children:(0,n.jsxs)(t.p,{children:["Note that submitting the report doesn't require the processor to start processing it right\naway, this can happen later (see ",(0,n.jsx)(t.a,{href:"#getlastprocessingrefslot",children:(0,n.jsx)(t.code,{children:"getLastProcessingRefSlot"})}),"). Until processing is started,\nHashConsensus is free to reach consensus on another report for the same reporting frame an\nsubmit it using this same function, or to lose the consensus on the submitted report,\nnotifying the processor via ",(0,n.jsx)(t.code,{children:"discardConsensusReport"}),"."]})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function submitConsensusReport(bytes32 reportHash, uint256 refSlot, uint256 deadline)\n"})}),"\n",(0,n.jsx)(t.h4,{id:"parameters-2",children:"Parameters"}),"\n",(0,n.jsxs)(t.table,{children:[(0,n.jsx)(t.thead,{children:(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.th,{children:"Name"}),(0,n.jsx)(t.th,{children:"Type"}),(0,n.jsx)(t.th,{children:"Description"})]})}),(0,n.jsxs)(t.tbody,{children:[(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"reportHash"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"bytes32"})}),(0,n.jsx)(t.td,{children:"Hash of the data calculated for the given reference slot."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"refSlot"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"uint256"})}),(0,n.jsx)(t.td,{children:"The reference slot the data was calculated for. Reverts if doesn't match the current reference slot."})]}),(0,n.jsxs)(t.tr,{children:[(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"deadline"})}),(0,n.jsx)(t.td,{children:(0,n.jsx)(t.code,{children:"uint256"})}),(0,n.jsx)(t.td,{children:"The timestamp of the last slot at which the report can be processed by the report processor contract."})]})]})]}),"\n",(0,n.jsx)(t.h3,{id:"discardconsensusreport",children:"discardConsensusReport()"}),"\n",(0,n.jsx)(t.p,{children:"Called by HashConsensus contract to notify that the report for the given ref. slot\nis not a consensus report anymore and should be discarded. This can happen when a member\nchanges their report, is removed from the set, or when the quorum value gets increased."}),"\n",(0,n.jsx)(t.p,{children:"Only called when, for the given reference slot:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"there previously was a consensus report; AND"}),"\n",(0,n.jsx)(t.li,{children:"processing of the consensus report hasn't started yet; AND"}),"\n",(0,n.jsx)(t.li,{children:"report processing deadline is not expired yet; AND"}),"\n",(0,n.jsxs)(t.li,{children:["there's no consensus report now (otherwise, ",(0,n.jsx)(t.a,{href:"#submitconsensusreport",children:"submitConsensusReport"})," is called instead)."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Can be called even when there's no submitted non-discarded consensus report for the current\nreference slot, i.e. can be called multiple times in succession."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function discardConsensusReport(uint256 refSlot)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"setconsensuscontract",children:"setConsensusContract()"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function setConsensusContract(address addr)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"setconsensusversion",children:"setConsensusVersion()"}),"\n",(0,n.jsx)(t.p,{children:"Sets the consensus version expected by the oracle contract."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"function setConsensusVersion(uint256 version)\n"})}),"\n",(0,n.jsx)(t.h2,{id:"permissions",children:"Permissions"}),"\n",(0,n.jsx)(t.h3,{id:"submit_data_role",children:"SUBMIT_DATA_ROLE()"}),"\n",(0,n.jsx)(t.p,{children:"An ACL role granting the permission to submit the data for a committee report."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:'bytes32 public constant SUBMIT_DATA_ROLE = keccak256("SUBMIT_DATA_ROLE");\n'})}),"\n",(0,n.jsx)(t.h3,{id:"manage_consensus_contract_role",children:"MANAGE_CONSENSUS_CONTRACT_ROLE()"}),"\n",(0,n.jsx)(t.p,{children:"An ACL role granting the permission to set the consensus contract address by calling setConsensusContract."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:'bytes32 public constant MANAGE_CONSENSUS_CONTRACT_ROLE = keccak256("MANAGE_CONSENSUS_CONTRACT_ROLE");\n'})}),"\n",(0,n.jsx)(t.h3,{id:"manage_consensus_version_role",children:"MANAGE_CONSENSUS_VERSION_ROLE()"}),"\n",(0,n.jsx)(t.p,{children:"An ACL role granting the permission to set the consensus version by calling setConsensusVersion."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:'bytes32 public constant MANAGE_CONSENSUS_VERSION_ROLE = keccak256("MANAGE_CONSENSUS_VERSION_ROLE");\n'})}),"\n",(0,n.jsx)(t.h2,{id:"events",children:"Events"}),"\n",(0,n.jsx)(t.h3,{id:"extradatasubmitted",children:"ExtraDataSubmitted()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when any extra report data for the current reporting frame has been submitted."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"ExtraDataSubmitted(uint256 indexed refSlot, uint256 itemsProcessed, uint256 itemsCount)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"warnextradataincompleteprocessing",children:"WarnExtraDataIncompleteProcessing()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when try to submit the same report, but not all items are processed yet."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event WarnExtraDataIncompleteProcessing(\n    uint256 indexed refSlot,\n    uint256 processedItemsCount,\n    uint256 itemsCount\n)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"consensushashcontractset",children:"ConsensusHashContractSet()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when a contract hash value is changed."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event ConsensusHashContractSet(address indexed addr, address indexed prevAddr)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"consensusversionset",children:"ConsensusVersionSet()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when a consensus version value is changed."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event ConsensusVersionSet(uint256 indexed version, uint256 indexed prevVersion)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"reportsubmitted",children:"ReportSubmitted()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when a new consensus report hash is submitted"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event ReportSubmitted(uint256 indexed refSlot, bytes32 hash, uint256 processingDeadlineTime)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"reportdiscarded",children:"ReportDiscarded()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when consensus report is discarded."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event ReportDiscarded(uint256 indexed refSlot, bytes32 hash)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"processingstarted",children:"ProcessingStarted()"}),"\n",(0,n.jsx)(t.p,{children:"Emits when report data is submitted"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event ProcessingStarted(uint256 indexed refSlot, bytes32 hash)\n"})}),"\n",(0,n.jsx)(t.h3,{id:"warnprocessingmissed",children:"WarnProcessingMissed()"}),"\n",(0,n.jsxs)(t.p,{children:["Emits on ",(0,n.jsx)(t.a,{href:"#submitconsensusreport",children:"submitConsensusReport"})," when ",(0,n.jsx)(t.code,{children:"refSlot != prevSubmittedRefSlot && prevProcessingRefSlot != prevSubmittedRefSlot"})]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-solidity",children:"event WarnProcessingMissed(uint256 indexed refSlot)\n"})}),"\n",(0,n.jsx)(t.h2,{id:"reverts-3",children:"Reverts"}),"\n",(0,n.jsx)(t.h3,{id:"submitreportdata-1",children:"submitReportData()"}),"\n",(0,n.jsx)(t.p,{children:"To ensure that the reported data is within possible values, the handler function performs a number of sanity checks. When checking, reverts may occur in different contracts."}),"\n",(0,n.jsx)(t.h4,{id:"accountingoracle-and-baseoracle-contracts",children:"AccountingOracle and BaseOracle contracts"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"SenderNotAllowed()"})," if caller doesn't have a ",(0,n.jsx)(t.code,{children:"SUBMIT_DATA_ROLE"})," role and is not a member of the oracle committee."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedContractVersion(expectedVersion, version)"})," if provided contract version is different from the current one."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedConsensusVersion(expectedConsensusVersion, consensusVersion)"})," if provided consensus version is different from the expected one."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedRefSlot(report.refSlot, refSlot)"})," if provided reference slot differs from the current consensus frame's one."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedDataHash(report.hash, hash)"})," if keccak256 hash of the ABI-encoded data is different from the last hash."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"NoConsensusReportToProcess()"})," if report hash data is 0."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"RefSlotAlreadyProcessing()"})," if report reference slot is equal to previous processing reference slot."]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedExtraDataHash(bytes32(0), data.extraDataHash)"})," if ",(0,n.jsx)(t.code,{children:"data.extraDataFormat"})," is ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_EMPTY"})," and ",(0,n.jsx)(t.code,{children:"data.extraDataHash"})," is 0"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnexpectedExtraDataItemsCount(0, data.extraDataItemsCount)"})," if ",(0,n.jsx)(t.code,{children:"data.extraDataFormat"})," is ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_EMPTY"})," and ",(0,n.jsx)(t.code,{children:"data.extraDataItemsCount"})," is not 0"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"UnsupportedExtraDataFormat(data.extraDataFormat)"})," if ",(0,n.jsx)(t.code,{children:"data.extraDataFormat"})," is not ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_EMPTY"})," and not ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_LIST"})]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ExtraDataItemsCountCannotBeZeroForNonEmptyData()"})," if ",(0,n.jsx)(t.code,{children:"data.extraDataFormat"})," is ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_LIST"})," and ",(0,n.jsx)(t.code,{children:"data.extraDataItemsCount"})," is 0"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ExtraDataHashCannotBeZeroForNonEmptyData()"})," if  ",(0,n.jsx)(t.code,{children:"data.extraDataFormat"})," is ",(0,n.jsx)(t.code,{children:"EXTRA_DATA_FORMAT_LIST"})," and ",(0,n.jsx)(t.code,{children:"data.extraDataHash"})," is 0"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"InvalidExitedValidatorsData()"})," if provided exited validators data doesn't meet safety checks."]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"oraclereportsanitychecker",children:"OracleReportSanityChecker"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"MaxAccountingExtraDataItemsCountExceeded(uint256 maxItemsCount, uint256 receivedItemsCount)"})," error when check is failed, more ",(0,n.jsx)(t.a,{href:"/lido-docs-spanish/contracts/oracle-report-sanity-checker#checkaccountingextradatalistitemscount",children:"here"})]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ExitedValidatorsLimitExceeded(uint256 limitPerDay, uint256 exitedPerDay)"})," if provided exited validators data doesn't meet safety checks. (OracleReportSanityChecker)"]}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"stakingrouter",children:"StakingRouter"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ArraysLengthMismatch(_stakingModuleIds.length, _exitedValidatorsCounts.length)"})," if provided exited validators data doesn't meet safety checks. (StakingRouter)"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ExitedValidatorsCountCannotDecrease()"})," if provided exited validators data doesn't meet safety checks. (StakingRouter)"]}),"\n",(0,n.jsxs)(t.li,{children:["Reverts with ",(0,n.jsx)(t.code,{children:"ReportedExitedValidatorsExceedDeposited(uint256 reportedExitedValidatorsCount,uint256 depositedValidatorsCount)"})," if provided exited validators data doesn't meet safety checks. (StakingRouter)"]}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Other reverts on ",(0,n.jsx)(t.code,{children:"Lido.handleOracleReport()"})]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>o});var n=s(6540);const r={},a=n.createContext(r);function i(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);